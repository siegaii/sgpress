# NodeJs 内存泄漏排查经验分享
「回顾2022，展望2023，我正在参与2022年终总结征文大赛活动」

## 前言
在 `Nodejs` 服务端开发的场景中，`内存泄漏` 绝对是最令人头疼的问题；
只要项目一直在开发迭代迭代，那么出现 `内存泄漏` 问题时绝对不可避免，只是出现的时间点不同而已。
所以作为一名优秀的 `Nodejs` 工程师一定需要系统性掌握有效的 `内存泄漏` 排查方法，缩短内存泄漏排查时间来降低业务上的损失。  

内存泄漏处理的难点就是如何能在成百上千的功能函数中找到，具体是哪一个功能中的哪一个函数的第多少行到多少行引起了内存泄漏。
很遗憾目前市面上没有能够轻松定位内存泄漏的工具，所以很多初次遇到这种问题的工程师会感到茫然，一下子不知道该如何处理。
这里我会以一次排查公司研发平台 `Nodejs` 服务 `内存泄漏` 的案例分享一下我的处理思路。

## 问题描述  
2022 Q3 的某天，研发用户群中反馈我们的研发平台不能访问，后台中出现了大量的异常任务未完成。
第一反应就是可能出现了内存泄漏还好服务接入了监控（`prometheus` + `grafana`）我直接就到 `grafana` 监控面板下查看服务器的状态, 发现果然出现了内存泄漏当时的监控面板大概如下

![DX 内存泄漏监控图](./DX%20%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9B%91%E6%8E%A7%E5%9B%BE.png)

从图中可以很明显的看出, 内存一直在涨没有下来过出现了明显的数据泄漏。

> **说明**：
> + `process memory`: `rss` (Resident Set Size)，进程的常驻内存大小。
> + `heapTotal`: V8 堆的总大小。
> + `heapUsed`: V8 堆已使用的大小。
> + `external`: V8 堆外的内存使用量。  
> 
> 在 `Nodejs` 中可以调用全局方法 `process.memoryUsage()` 获取这些数据其中 `heapTotal` 和 `heapUsed` 是 V8 堆的使用情况，V8 堆是 `Node.js` 中 JavaScript 对象存储的地方。而 `external` 则表示非 V8 堆中分配的内存，例如 C++ 对象。`rss` 则是进程所有内存的使用量。一般看监控数据的时候重点关注 `heapUsed` 的指标就行了


## 内存泄漏类型
内存泄漏主要分为：
+ 全局性泄漏
+ 局部泄漏
> 其实不管是全局性内存泄漏还是局部性的内存泄漏，要做的都是尽可能缩小排除范围。

## 全局性内存泄漏
全局性内容泄漏出现一般高发于：`中间件`与`组件`中，这种类型的内存泄漏排查起来也是最简单的。

### 二分法排查
这种类型我就不讲其它科学的分析方法了，这种情况下我认为使用二分法排查是最快的。

`二分法流程`：
1. 先注释一半的代码（减少一半`中间件`、`组件`、或其它公用逻辑的使用）
2. 随便选择一个接口或新写一个测试接口进行压测
3. 如果出现内存泄漏，那么泄漏点就在当前使用的代码之中，若没有泄漏则泄漏点出现在
4. 然后一直循环往复上述流程大约 20 ~ 60 min 一定可以定位到内存泄漏的详细位置

> 2020 年的时候我在实习僧做基于 `Nuxt` SSR 应用压测时发现内存泄漏，判断定为全局性的泄漏之后，采用二分法排查大约花了 30min 就成功定位了问题。
> 当时泄漏的原因是我们在服务端使用 `axios` 导致的泄漏，后来统一 `axios` 相关的全换成 `node-fetch` 后就解决了,从此换上了 `axios PDST` 后来绝对不会在 `Node` 服务中使用 `axios` 了 


全局性内存泄漏   
如果判断出所有的泄漏发生在全局那么恭喜你，这种情况是最容易排查的，排查起来非常快。
全局性内容泄漏出现一般高发于：`中间件`与`组件`中，这种情况想要定位内存泄漏点非常简单，用二分法就行了。

只需要随便对一个接口进行压测，注释一半的功能代码，如果出现内存泄漏问题就是在没有注释的代码中，没有出现就在另一半之中








## 总结
1. 服务需要接入监控，方便第一时间确定问题类型
2. 判断内存泄漏是全局性的还是局部性的

## 其它
+ 压测工具：wrk




https://www.cnblogs.com/strick/p/16313530.html

https://blog.csdn.net/pengpengzhou/article/details/106811717


[Nodejs 性能监控](https://www.cnblogs.com/strick/p/16300059.html)

















## 一些概念
### Nodejs 调试模式
[Node 调试模式](https://nodejs.org/en/docs/guides/debugging-getting-started/)

在启动 Node 时加入 --inspect 参数可以开启调试模式。

### heapdump

### V8 中的 GC

> 手动触发 GC Node.js支持一个命令行选项 `--expose-gc`，该选项将向该 `global` 对象添加 `gc()` 函数，比如您可以这样执行您的代码：

### 压测工具
[压测介绍](https://www.cnblogs.com/goldsunshine/p/16607820.html)

[wrk 使用](https://juejin.cn/post/6987391274508615694)

+ 文章类型：技术总结
+ 文章分类：代码人生
